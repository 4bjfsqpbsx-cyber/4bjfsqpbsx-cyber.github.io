<script>
lucide.createIcons();
document.getElementById('currentYear').textContent = new Date().getFullYear();

let currentSlide = 0;
let totalSlides = 0;
let visibleCards = 3;
let currentRating = 0;

document.addEventListener('DOMContentLoaded', () => {
  const splash = document.getElementById('splash');
  setTimeout(() => {
    splash.classList.add('splash-hidden');
    setTimeout(() => splash.remove(), 500);
  }, 1200);

  initMap();
  initFAQ();
  initReviews();
  initNav();
  initStarRating();
  initCarousel();
  initMessengerToggle();

  window.addEventListener('resize', () => {
    calculateCardWidth();
    goToSlide(currentSlide);
  });
});

function initNav() {
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.nav-link');

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute('id');
        navLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${id}`) {
            link.classList.add('active');
          }
        });
      }
    });
  }, { rootMargin: '-20% 0px -80% 0px' });

  sections.forEach(section => observer.observe(section));
}

function setRating(rating) {
  currentRating = rating;
  highlightStars(rating);
  updateRatingText(rating);
  const selectedRating = document.getElementById('selected-rating');
  selectedRating.textContent = `${rating} из 5`;
  selectedRating.classList.remove('hidden');
}

function renderReviews(reviewsArray) {
  const container = document.getElementById('reviews-container');
  container.innerHTML = '';
  calculateCardWidth();

  reviewsArray.forEach(review => {
    const reviewEl = createReviewElement(review);
    reviewEl.classList.add('review-card');
    container.appendChild(reviewEl);
  });

  totalSlides = Math.max(0, Math.ceil(reviewsArray.length / visibleCards) - 1);
  createIndicators();
  updateCarouselButtons();

  document.getElementById('rating-text').textContent =
    `4.9 — на основе ${reviewsArray.length} отзывов`;
}

function createReviewElement(review) {
  const reviewEl = document.createElement('div');
  reviewEl.className = 'p-6 rounded-2xl bg-gray-50 shadow-lg hover:shadow-xl transition-shadow h-full border border-gray-100';

  let starsHtml = '';
  for (let i = 1; i <= 5; i++) {
    starsHtml += i <= review.rating
      ? '<span class="text-yellow-400 text-lg">★</span>'
      : '<span class="text-gray-300 text-lg">★</span>';
  }

  reviewEl.innerHTML = `
    <div class="flex justify-between items-start mb-4">
      <div class="flex items-center gap-2">
        ${starsHtml}
        <span class="text-sm font-bold text-gray-700">${review.rating}.0</span>
      </div>
    </div>
    <p class="text-gray-700 mb-4 text-sm leading-relaxed">${review.text}</p>
    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
      <div>
        <p class="font-bold text-gray-800">${review.name}</p>
        <p class="text-xs text-gray-500 mt-1">${review.location}</p>
      </div>
      <div class="w-10 h-10 bg-accent/10 rounded-full flex items-center justify-center">
        <i data-lucide="user" class="w-5 h-5 text-accent"></i>
      </div>
    </div>
  `;
  return reviewEl;
}

function createIndicators() {
  const indicatorsContainer = document.getElementById('carousel-indicators');
  indicatorsContainer.innerHTML = '';

  for (let i = 0; i <= totalSlides; i++) {
    const indicator = document.createElement('div');
    indicator.className = `indicator ${i === 0 ? 'active' : ''}`;
    indicator.dataset.index = i;
    indicator.addEventListener('click', () => goToSlide(i));
    indicatorsContainer.appendChild(indicator);
  }
}

function goToSlide(slideIndex) {
  if (slideIndex < 0 || slideIndex > totalSlides) return;
  currentSlide = slideIndex;

  const container = document.getElementById('reviews-container');
  const cards = container.querySelectorAll('.review-card');
  if (!cards.length) return;

  const cardWidth = cards[0].offsetWidth + 24;
  const offset = -currentSlide * visibleCards * cardWidth;
  container.style.transform = `translateX(${offset}px)`;

  document.querySelectorAll('.indicator').forEach((indicator, index) => {
    indicator.classList.toggle('active', index === currentSlide);
  });

  updateCarouselButtons();
}

function updateAverageRating(reviews) {
  document.getElementById('rating-text').textContent =
    `4.9 — на основе ${reviews.length} отзывов`;

  document.getElementById('average-rating').innerHTML = '★★★★★';
}

function initMap() {
  const mapContainer = document.getElementById('map');
  const exactCoords = [55.606883, 37.969838];

  const mapIframe = document.createElement('iframe');
  mapIframe.src = `https://yandex.ru/map-widget/v1/?ll=${exactCoords[1]},${exactCoords[0]}&z=18&pt=${exactCoords[1]},${exactCoords[0]},pm2rdm`;
  mapIframe.width = '100%';
  mapIframe.height = '100%';
  mapIframe.style.border = 'none';
  mapIframe.loading = 'lazy';
  mapContainer.appendChild(mapIframe);
}
</script>
